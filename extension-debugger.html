<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LLM翻译插件调试工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    h1, h2 {
      color: #333;
    }
    button {
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    .result {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      min-height: 40px;
      white-space: pre-wrap;
      background-color: #f5f5f5;
    }
    .danger {
      background-color: #f44336;
    }
    .danger:hover {
      background-color: #d32f2f;
    }
    .warn {
      background-color: #ff9800;
    }
    .warn:hover {
      background-color: #fb8c00;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <h1>LLM翻译插件调试工具</h1>
  <p>此工具帮助您排查插件中的常见问题，并提供解决方案</p>
  
  <div class="container">
    <h2>1. 插件状态检查</h2>
    <button id="checkExtensionBtn">检查插件状态</button>
    <div class="result" id="extensionStatusResult">点击按钮检查插件状态...</div>
  </div>
  
  <div class="container">
    <h2>2. API设置检查</h2>
    <button id="checkSettingsBtn">检查API设置</button>
    <div class="result" id="settingsResult">点击按钮检查API设置...</div>
  </div>
  
  <div class="container">
    <h2>3. 内容脚本检查</h2>
    <button id="checkContentScriptBtn">检查内容脚本</button>
    <div class="result" id="contentScriptResult">点击按钮检查内容脚本是否正常加载...</div>
  </div>
  
  <div class="container">
    <h2>4. 清除插件设置</h2>
    <p>如果遇到问题，您可以尝试重置插件设置</p>
    <button id="resetSettingsBtn" class="warn">重置为默认设置</button>
    <button id="clearAllSettingsBtn" class="danger">清除所有设置</button>
    <div class="result" id="resetResult">重置结果将显示在这里...</div>
  </div>
  
  <div class="container">
    <h2>5. 常见问题</h2>
    <table>
      <tr>
        <th>问题</th>
        <th>可能原因</th>
        <th>解决方案</th>
      </tr>
      <tr>
        <td>Extension context invalidated</td>
        <td>插件被重新加载或禁用</td>
        <td>刷新页面，或重启浏览器</td>
      </tr>
      <tr>
        <td>翻译按钮不出现</td>
        <td>内容脚本未正确加载</td>
        <td>检查"内容脚本检查"结果</td>
      </tr>
      <tr>
        <td>API请求失败</td>
        <td>API密钥或端点错误</td>
        <td>检查"API设置检查"结果</td>
      </tr>
      <tr>
        <td>网络错误或CORS问题</td>
        <td>浏览器安全策略阻止请求</td>
        <td>确保manifest.json中有正确的host_permissions</td>
      </tr>
      <tr>
        <td>翻译结果解析错误</td>
        <td>API响应格式与预期不符</td>
        <td>使用test-api.html检查API响应格式</td>
      </tr>
    </table>
  </div>

  <script>
    // 检查插件状态
    document.getElementById('checkExtensionBtn').addEventListener('click', function() {
      const result = document.getElementById('extensionStatusResult');
      result.textContent = '正在检查...';
      
      try {
        // 检查manifest.json版本
        const manifestVersion = chrome.runtime.getManifest().manifest_version;
        const extVersion = chrome.runtime.getManifest().version;
        const permissions = chrome.runtime.getManifest().permissions;
        const hostPermissions = chrome.runtime.getManifest().host_permissions || [];
        
        let status = `插件状态: 正常\n`;
        status += `版本: ${extVersion}\n`;
        status += `Manifest版本: ${manifestVersion}\n`;
        status += `权限: ${permissions.join(', ')}\n`;
        status += `主机权限: ${hostPermissions.join(', ') || '无'}\n`;
        
        result.textContent = status;
      } catch (error) {
        result.textContent = `检查失败: ${error.message}\n\n如果出现"Extension context invalidated"错误，请刷新页面或重启浏览器。`;
      }
    });
    
    // 检查API设置
    document.getElementById('checkSettingsBtn').addEventListener('click', function() {
      const result = document.getElementById('settingsResult');
      result.textContent = '正在检查API设置...';
      
      try {
        chrome.storage.sync.get(
          {
            model: 'THUDM/GLM-4-9B-0414',
            customModelName: '',
            customModelEndpoint: '',
            apiKey: 'sk-yhszqcrexlxohbqlqjnxngoqenrtftzxvuvhdqzdjydtpoic',
            defaultApiEndpoint: 'https://api.siliconflow.cn/v1/chat/completions'
          }, 
          function(items) {
            let status = `API设置检查结果:\n`;
            status += `当前模型: ${items.model}\n`;
            status += `API密钥: ${items.apiKey ? '已设置' : '未设置'}\n`;
            status += `默认API端点: ${items.defaultApiEndpoint || '未设置'}\n`;
            
            if (items.model === 'custom') {
              status += `\n自定义模型设置:\n`;
              status += `模型名称: ${items.customModelName || '未设置'}\n`;
              status += `API端点: ${items.customModelEndpoint || '未设置'}\n`;
            }
            
            // 验证端点
            try {
              if (items.model === 'custom' && items.customModelEndpoint) {
                new URL(items.customModelEndpoint);
                status += `\n自定义端点格式: 有效\n`;
              } else if (items.defaultApiEndpoint) {
                new URL(items.defaultApiEndpoint);
                status += `\n默认端点格式: 有效\n`;
              } else {
                status += `\n警告: 未找到有效的API端点\n`;
              }
            } catch (e) {
              status += `\n错误: API端点格式无效 - ${e.message}\n`;
            }
            
            result.textContent = status;
          }
        );
      } catch (error) {
        result.textContent = `检查失败: ${error.message}`;
      }
    });
    
    // 检查内容脚本
    document.getElementById('checkContentScriptBtn').addEventListener('click', function() {
      const result = document.getElementById('contentScriptResult');
      result.textContent = '正在检查内容脚本...';
      
      try {
        chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
          if (!tabs || tabs.length === 0) {
            result.textContent = '错误: 无法获取当前标签页';
            return;
          }
          
          const activeTab = tabs[0];
          chrome.scripting.executeScript({
            target: {tabId: activeTab.id},
            function: () => {
              // 检查内容脚本元素
              const translateButtons = document.querySelectorAll('.llm-translate-button');
              const translationPopups = document.querySelectorAll('.llm-translation-popup');
              
              // 检查样式是否加载
              const hasStyles = (() => {
                for (let i = 0; i < document.styleSheets.length; i++) {
                  try {
                    const rules = document.styleSheets[i].cssRules;
                    for (let j = 0; j < rules.length; j++) {
                      if (rules[j].selectorText && 
                          (rules[j].selectorText.includes('.llm-translate-button') || 
                           rules[j].selectorText.includes('.llm-translation-popup'))) {
                        return true;
                      }
                    }
                  } catch (e) {
                    // 可能因为CORS限制无法读取样式表规则
                  }
                }
                return false;
              })();
              
              return {
                buttons: translateButtons.length,
                popups: translationPopups.length,
                hasStyles: hasStyles,
                contentLoaded: typeof selectedText !== 'undefined' && typeof translationPopup !== 'undefined'
              };
            }
          }).then(results => {
            if (!results || results.length === 0) {
              result.textContent = '错误: 无法在当前页面执行脚本';
              return;
            }
            
            const data = results[0].result;
            let status = `内容脚本检查结果:\n`;
            
            if (data.contentLoaded) {
              status += `✅ 内容脚本已正确加载\n`;
            } else {
              status += `❌ 内容脚本未加载或变量不可访问\n`;
            }
            
            status += `翻译按钮元素: ${data.buttons}个\n`;
            status += `翻译弹窗元素: ${data.popups}个\n`;
            
            if (data.hasStyles) {
              status += `✅ 样式表已正确加载\n`;
            } else {
              status += `❌ 未检测到样式表规则\n`;
            }
            
            status += `\n提示: 在网页上选择一些文本，应该会看到翻译按钮\n`;
            
            result.textContent = status;
          }).catch(error => {
            result.textContent = `检查失败: ${error.message}\n\n可能的原因: 未获得当前页面的脚本执行权限或内容脚本未能正确注入`;
          });
        });
      } catch (error) {
        result.textContent = `检查失败: ${error.message}`;
      }
    });
    
    // 重置设置
    document.getElementById('resetSettingsBtn').addEventListener('click', function() {
      const result = document.getElementById('resetResult');
      result.textContent = '正在重置为默认设置...';
      
      try {
        chrome.storage.sync.set({
          model: 'THUDM/GLM-4-9B-0414',
          customModelName: '',
          customModelEndpoint: '',
          apiKey: 'sk-yhszqcrexlxohbqlqjnxngoqenrtftzxvuvhdqzdjydtpoic',
          defaultApiEndpoint: 'https://api.siliconflow.cn/v1/chat/completions'
        }, function() {
          result.textContent = '✅ 已成功重置为默认设置';
        });
      } catch (error) {
        result.textContent = `重置失败: ${error.message}`;
      }
    });
    
    // 清除所有设置
    document.getElementById('clearAllSettingsBtn').addEventListener('click', function() {
      if (!confirm('确定要清除所有设置吗？这将删除所有已保存的配置。')) {
        return;
      }
      
      const result = document.getElementById('resetResult');
      result.textContent = '正在清除所有设置...';
      
      try {
        chrome.storage.sync.clear(function() {
          result.textContent = '✅ 已成功清除所有设置';
        });
      } catch (error) {
        result.textContent = `清除失败: ${error.message}`;
      }
    });
  </script>
</body>
</html> 